generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id           Int                @id @default(autoincrement())
  email        String             @unique
  businessName String?
  passwordHash String?
  country      String?
  role         String             @default("user")
  createdAt    DateTime           @default(now())

  recipes      AutomationRecipe[]
  insights     Insight[]
  revenues     RevenueData[]
  channels     SalesChannel[]
  orders       Order[]
  integrations Integration[]
}

model Integration {
  id          Int      @id @default(autoincrement())
  provider    String   // WHATSAPP, TELEGRAM, SMS_GATEWAY, EMAIL, SHOPEE, TOKOPEDIA, LAZADA, TIKTOK
  name        String   // Display name e.g. "WhatsApp Bisnis Utama"
  credentials Json     // Stores API keys, tokens, secrets flexibly
  isActive    Boolean  @default(false)
  lastSyncAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId Int
  user   User @relation(fields: [userId], references: [id])

  @@unique([userId, provider])
  @@index([userId])
}

model AutomationRecipe {
  id            Int      @id @default(autoincrement())
  title         String
  description   String?
  enabled       Boolean  @default(false)
  config        Json     // Trigger settings, thresholds, etc.
  category      String
  integrationId Int?     // Which integration to use (optional)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userId Int
  user   User   @relation(fields: [userId], references: [id])

  @@index([userId])
}

enum InsightType {
  warning
  success
  info
}

model Insight {
  id        Int         @id @default(autoincrement())
  title     String
  type      InsightType
  message   String
  action    String?
  createdAt DateTime    @default(now())

  userId Int
  user   User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model RevenueData {
  id        Int      @id @default(autoincrement())
  month     String
  year      Int      @default(2024)
  revenue   Int      @default(0)
  cost      Int      @default(0)
  orders    Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId Int
  user   User @relation(fields: [userId], references: [id])

  @@unique([userId, month, year])
  @@index([userId])
}

model SalesChannel {
  id        Int      @id @default(autoincrement())
  name      String
  icon      String   @default("ðŸ›’")
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())

  userId Int
  user   User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Order {
  id          Int      @id @default(autoincrement())
  orderNumber String
  amount      Int
  status      String   @default("pending")
  channel     String?
  createdAt   DateTime @default(now())

  userId Int
  user   User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
}
